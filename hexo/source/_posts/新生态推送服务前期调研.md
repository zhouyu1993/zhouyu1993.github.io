---
title: 新生态推送服务前期调研

categories:
  - web

tags:
  - 工作

date: 2019/01/30
---

本文是对新生态推送服务前期调研的汇报。

<!-- more -->

## 推送服务

首先我个人之前对推送服务不太了解，经过这两个月的接触，有了以下一些粗略的认知。

> 所谓推送，就是信息的 “web广播”，是通过一定的技术标准或协议，在互联网上定期传送用户需要的信息，从而来减少信息过载、减少用户网络搜索时间的一项技术。它根据用户的兴趣来搜索、过滤信息，并将信息定期推送给用户，帮助用户高效率地发掘有价值的信息。

提取关键词：定期、兴趣、搜索、过滤、效率。

> 从技术而言，信息推送是一项以数据挖掘、自然语言处理以及互联网等多门技术为基础的综合性方向。将合适的信息推送给合适的人，是一项极具挑战的工作。这个过程需要对信息作充分的分析，并对人的兴趣、行为做细致的刻画，并对两者进行有效匹配。

提取关键句：将合适的信息推送给合适的人。

### 推送服务原理

手机上的推送服务原理很简单，就是通过建立一条手机与服务器之间的连接链路（即长连接），当有消息需要发送到手机时，通过此链路发送即可。

长连接，指在一个连接上可以连续发送多个数据包，在连接保持期间，如果没有数据包发送，需要双方发链路检测包。

推送服务的使用流程虽然略有差别（不同系统、不同设备），但是大致都和 IOS 的 APNS 相似。

先看几个名词：

  * IOS 应用程序即 App。
  * APNS (Apple Push Notification Service)，苹果推送通知服务。
  * PUSH 服务端程序，指某个 App 内使用的具体推送接口。
  * deviceToken 用户标识，可能是设备信息、应用信息等。

推送服务过程：

  1. 首先是 IOS 应用程序注册消息推送（接入推送服务）；
  2. IOS 应用程序向 APNS 索要 deviceToken，IOS 应用程序接受 deviceToken（获取用户标识/口/密钥，用于确认）；
  3. IOS 应用程序将 deviceToken 发送给 PUSH 服务端程序（授权服务端）。
  4. PUSH 服务端程序向 APNS 发送消息。
  5. APNS 将消息发送给 IOS 应用程序。

**App - PUSH 服务端（第三方/桥梁） - PNS**

应用程序，多端，包括：App (Android、Ios)、快应用 (Android)、小程序 (微信、QQ、支付宝、头条、百度等)、Web (PC、Mobile、PWA)等。我们在 PC 上使用邮箱或者微博时，经常会有个提示框，“禁止/允许显示通知”，这个就类似对推送服务的授权。

PNS，则是设备系统（厂商）提供的推送通知服务，苹果、安卓或者电脑客户端等。小米则对应 MIUI 系统。

我们关心以下5个环节：

  1. 应用程序注册？（客户端做的事）
  2. 应用程序怎么向 PNS 索要 deviceToken？（客户端做的事）
  3. 应用程序怎么将 deviceToken 发送给 PUSH 服务端程序？（客户端做的事）
  4. PUSH 服务端程序怎么向 PNS 发送消息？（服务端做的事）
  5. PNS 怎么将消息发送给应用程序？（厂商做的事）

下面我们分别看一下不同应用程序在推送能力上的发展。

## App

App 方面我就不说了，目前小米推送对 Android、Ios 都已经支持。未来做的更多是，在支持全 Android 上的发展。

## 快应用

官方在[推送能力](https://doc.quickApp.cn/features/service/push.html)上已经提供了相关接口。

``` js
// 接入推送服务
import push from '@service.push'

// 订阅 push，后续可以收到 push 消息（一般可在应用初始化的地方进行调用。比如在 App 的 onCreate 方法中调用。）
// 这里其实就是授权开启推送服务
push.subscribe({
  success: function (data) {
    console.log(
      `push.subscribe succeeded, result data = ${JSON.stringify(data)}`
    )
    // regId，PushService 返回的注册 id，可用于针对某个用户发送消息
    console.log(data.regId)
  },
  fail: function (data, code) {
    console.log(
      `push.subscribe failed, result data = ${JSON.stringify(
        data
      )}, code = ${code}`
    )
  },
  complete: function () {
    console.log('push.subscribe completed')
  }
})

// 获取服务提供商，字符串，服务提供商的代号，如厂商的英文品牌名称，假如无此服务则返回空字符串
console.log(push.getProvider())

// 添加 push 事件回调（透传消息的 payload 内容可在此回调中收到）
push.on({
  callback: function (ret) {
    console.log(`received pass through message, ret = ${JSON.stringify(ret)}`)
  }
})
```

官网上所展现的前端如何接入推送服务，还是比较简单的。

在支持明细中，可以看到已经有 5 家厂商支持。

![快应用推送支持](https://cmspic-10004025.image.myqcloud.com/6cfe8780-91c7-43f9-8688-77bb39c212f4)

我们看到小米对应的就是小米消息推送服务。而且对应上面提供的 API 来看，目前已经支持通知栏消息和透传消息。可见快应用中推送服务的应用，应该和安卓中推送服务的应用，大同小异。

未来设想或预期是这样的，小米消息推送服务能够去支持其他厂商，支持全 Android 的 App 同时，也支持全 Android 的快应用。

另外，以下 API 是可能需要：

 * [设备信息](https://doc.quickApp.cn/features/system/device.html)，获取设备信息、获取设备唯一标识、获取用户唯一标识等。
 * [应用信息](https://doc.quickApp.cn/features/system/App.html)，获取应用信息。
 * [路由信息](https://doc.quickApp.cn/features/system/router.html)，`router.getState()` 获取路由信息。
 * 获取地理位置、网路状态等其他信息

### 快应用推送演示

小米漂流瓶（自研快应用业务团队）：

我方捞瓶子对话，熄屏等待对方回话。对方回话，我方接收到一条推送

小米手机（MIUI 10）的通知栏上直接显示小米漂流瓶，可见快应用跟 App 没什么区别

![小米漂流瓶1](https://cmspic-10004025.image.myqcloud.com/4dec6680-b126-4b46-8a3e-3d726ecacba1)

点击通知栏上的消息卡片，即可直接进入小米漂流瓶对应的消息对话页面：

![小米漂流瓶2](http://cmspic-10004025.image.myqcloud.com/dfbf44d7-05b6-4e61-8266-79a7601dc032)

另外，我分别在小米手机以及魅族手机上测试了京东的客服系统，以及唯品会的订单系统。跟客服对话，退出/熄屏后没有消息提示；下单不支付超时也没有消息提示，可能都没有接入推送服务。一个是目前快应用推送服务接入还是比较繁琐；二个是快应用使用量可能不够大。

当我们能够提供全 Android 的支持，简化了接入流程，或许就可以吸引 CP 进行接入。

## 小程序

小程序是以 App 为载体的，从目前推送服务的呈现效果来看，是通知栏跟 App 之间的交互，而非快应用那种直达，更不用说透传消息。未来有没有可能做成直达，或者支持透传消息，这就要看各大 App 的发展了。

### 微信/QQ 小程序 (腾讯系)

微信小程序是以微信为载体的。

在微信小程序中是无法获取到设备信息、设备唯一标识、用户唯一标识这些东西的。

我们可以通过 [wx.getSystemInfo](https://developers.weixin.qq.com/miniprogram/dev/api/wx.getSystemInfo.html) 来获取到系统信息及小程序信息，但用处有限。

目前微信小程序的消息推送，是借助于【模版消息】实现的。

“模板消息”是什么？

模板消息是微信提供的消息推送的能力，以服务通知的形式将小程序的消息推送至用户的聊天列表。在进入小程序服务通知时，能看到小程序的推送消息。这个消息可以是活动信息，可以是商品降价信息，将运营者想向用户传达的消息直接传递至用户。用户甚至可以点击服务消息进入小程序，进入到运营者指定的页面。

#### 模版消息

> 基于微信的通知渠道，微信为开发者提供了可以高效触达用户的模板消息能力，以便实现服务的闭环并提供更佳的体验。

  * 模板推送位置：`服务通知`
  * 模板下发条件：用户本人在微信体系内与页面有交互行为后触发，【支付或提交表单】
  * 模板跳转能力：点击查看详情仅能跳转下发模板的该帐号的各个页面

##### 具体能力

开发者/运营者在微信公众平台 https://mp.weixin.qq.com 配置模版消息，有模版库可选，也可自定义模版：

![微信公众平台-模版消息1](http://cmspic-10004025.image.myqcloud.com/fab8efec-4f8b-41f7-b85e-f0a895eea5d9)

![微信公众平台-模版消息2](http://cmspic-10004025.image.myqcloud.com/5ceee21b-8933-4069-8389-21dd0679e63e)

![微信公众平台-模版消息3](http://cmspic-10004025.image.myqcloud.com/d3da1d4e-3393-4357-9a28-aa38e321f27d)

前端接入：
  * 当用户完成[支付行为](https://developers.weixin.qq.com/miniprogram/dev/api/wx.requestPayment.html)，可以获取 `prepay_id` 用于发送模板消息
  * 页面的 [`<form>`](https://developers.weixin.qq.com/miniprogram/dev/component/form.html) 组件，属性 `report-submit` 为 `true` 时，可以声明为需要发送模板消息，此时点击按钮提交表单可以获取 `formId`，用于发送模板消息

服务端调用微信接口，对模板消息进行管理：
  * [获取小程序模板库标题列表](https://developers.weixin.qq.com/miniprogram/dev/api/getTemplateLibraryList.html)
  * [获取模板库某个模板标题下关键词库](https://developers.weixin.qq.com/miniprogram/dev/api/getTemplateLibraryById.html)
  * [组合模板并添加至帐号下的个人模板库](https://developers.weixin.qq.com/miniprogram/dev/api/addTemplate.html)
  * [获取帐号下已存在的模板列表](https://developers.weixin.qq.com/miniprogram/dev/api/getTemplateList.html)
  * [删除帐号下的某个模板](https://developers.weixin.qq.com/miniprogram/dev/api/deleteTemplate.html)

服务端发送模版消息接口：[sendTemplateMessage](https://developers.weixin.qq.com/miniprogram/dev/api/sendTemplateMessage.html)

我们无法主动向用户推送，只有接受到用户指令才能推送。需要接受到 `prepay_id` 或者 `formId`。这跟微信公众号不同，微信公众号是可以主动推送的。

##### 支付

当用户在小程序内完成过支付行为，可允许开发者向用户在 7 天内推送有限条数的模板消息（1 次支付可下发 3 条，多次支付下发条数独立，互相不影响）

`wx.requestPayment` 支付完成后获取的 `prepay_id` 跟 `formId` 类似，不过 `prepay_id` 就具体代表了支付行为。

##### 提交表单

当用户在小程序内发生过提交表单行为且该表单声明为要发模板消息的，开发者需要向用户提供服务时，可允许开发者向用户在 7 天内推送有限条数的模板消息（1 次提交表单可下发 1 条，多次提交下发条数独立，相互不影响）

前端接入：

``` html
<form report-submit bindsubmit="tracker" class="reset-form my-class">
  <button formType="submit" class="reset-button">
    <slot></slot>
  </button>
</form>
```

``` js
import md5 from 'crypto-js/md5'

// 小程序 AppId 等信息
const AppId = 'App_id'
const url = 'url'

Component({
  methods: {
    tracker (e) {
      // 这里获取 formId，每获取一次，则可下发1条
      const formId = e.detail && e.detail.formId

      if (formId === 'the formId is a mock one') return console.warn(`模拟器操作不上报formid, 合法request里需要配置 ${WXDATA}`)

      // 采集 formId
      wx.login({
        success: ({ code }) => {
          // 登录获取用户 code

          // 将 AppId、formId、code 等整合
          const str = `${AppId}${formId}${code}`
          // 加密
          const sign = md5(str)

          // 发送给服务端【告诉服务端可以发送模版消息】
          request({
            url: `${url}?App_id=${AppId}&form_id=${formId}&code=${code}&sign=${sign}`,
            showLoading: false,
            fail: () => {},
            isSuccess: () => true,
            success: () => {},
          })
        },
      })
    },
  },
})
```

`form` 内的每次点击都会触发 `submit` 事件！

#### 微信小程序推送演示

小米商城 -> 闪购 -> 提醒我

用户点击【提醒我】按钮。提交表单获取 `formId`，发送给服务端。

![小米商城1](http://cmspic-10004025.image.myqcloud.com/e766e2d0-2e68-43c4-bee4-3869b6aceeea)

服务端接受到 `formId`，同时根据`某些参数`判断该 `formId` 是个定时提醒功能，从而在指定时间下发指定模版。

客户端接受到通知。这里看到，通知栏是微信的消息，说明确实借助的还是微信自身的推送功能，是微信与设备之间的连接。

![小米商城2](http://cmspic-10004025.image.myqcloud.com/a3e7ef8a-9459-435f-87a4-5bcdac230780)

点击这条通知栏消息，打开微信，我们看到顶部有一栏消息【服务通知】。显然【服务通知】类似于一个特别的【联系人或者公众号】，用来存放微信所有的通知。

![小米商城3](http://cmspic-10004025.image.myqcloud.com/179b3307-2037-48bb-b8ba-bbba2ab8f9b0)

点击【服务通知】，可以看到小程序【小米商城】发来的通知。这个通知，和小米商城的微信公众平台上配置的模版，是一模一样的，只是有了具体内容。

![小米商城4](http://cmspic-10004025.image.myqcloud.com/3f3a429f-5e10-4259-90b6-80f46c9003bc)

点击这条通知，跳转到小程序【小米商城】的指定页面。

![小米商城5](http://cmspic-10004025.image.myqcloud.com/a4a7b1cd-a815-4f3d-9e5c-69cbc6f285da)

上面展示了用户主动要求提醒的流程，而且这个提醒是一次性的，用户点击 1 次只会定时发送 1 条。

那如果有个每天定时提醒的需求呢？

例如【孩子王-天天打开领现金】，需求是用户设置【打卡提醒】后，接下来的【1.17-1.31】每天早上9点进行提醒！

![孩子王1](http://cmspic-10004025.image.myqcloud.com/8450b643-5a3d-4ac7-ab70-f5c05fd1ca0c)

如何在用户点击一次按钮后，拥有向用户发送多个通知的能力？网上也提供了一些解决方案。

[微信小程序如何突破模板消息限制，获取多个formId](https://segmentfault.com/a/1190000016214784)

这里给出的方案是嵌套 N 个 `form`，利用点击穿透，同时提交多个 `form`，以获取多个不同的 `formId` 来发送多个消息模板通知。

[突破微信小程序模板消息限制，实现无限制主动推送](https://blog.csdn.net/rolan1993/article/details/79398362)

为了突破模板消息的推送限制，实现 7 天内任性推送，只需收集到足够的推送码。一个 `formId` 代表着开发者有向当前用户推送模板消息的一次权限。

将 `form` 套在页面最外层，这样用户只要点击，不管点什么，都会去发送一个推送码，从而就能不停地收集。

这种做法也是迫不得已的，耍小聪明。不停收集，收集了很多垃圾信息。另外如果滥用通知，就会导致模板消息被封。

我们是不是可以提供更好的解决方案？如何收集推送码，这个问题是前端需要考虑的，当然也可以放到将来的新生态统计业务中。

张小龙在微信公开课上关于“用户将小程序找回”的问题时说：

> “很多人说小程序为什么不能发通知或推送？但是我们看到在手机上，每一个 App 都会把消息推送使用到尽，最终的结果是，用户只好忽略了所有的推送，所以靠推送是不能解决问题的。即使我们提供了一种叫模板消息的能力，也会被滥用掉。所有的公司都有骚扰用户的动机，就不能指望所有的公司有自我克制的能力。”

确实是这样，我手机里面大部分App的通知提醒都被我忽略禁止了，因为有强迫症，有消息通知（红点）我就要里面去点开，然后想办法去掉红点，很多时候连标题都没看我就直接关闭了。

模板消息滥用，会被用户举报，导致模板消息被封，这让小程序开发者/运营者们很痛苦。

![微信公众平台1](http://cmspic-10004025.image.myqcloud.com/2dd06151-d69e-4600-95dd-83804f7332e4)

以上，大概可以总结出两点，我们将来做小程序推送SDK，有两个目的：1是封装集成，方便开发者接入；2是降低模板消息被封概率，使小程序推送更准确更直观。

目前有这几个平台已经开始做了这样的事情：

  * [阿拉丁-小神推](https://www.xiaoshentui.com/)
  * [知晓云](https://doc.minApp.com/js-sdk/template-message.html)
  * [vpush](http://doc.mssnn.cn/870251)
  * [bmob](https://docs.bmob.cn/data/wechatApp/b_developdoc/doc/index.html#小程序模板消息)

以【阿拉丁-小神推】为例子，根据用户特征打标签，根据用户行为事件打标签，根据用户对消息的回访状况打标签。这意味，在不同场景下，收集 formId，每一种场景的 formId 代表一类标签。这样既有足够的 formId，又能根据标签分类，将用户数据化分析，从而做到推送精确，回报率高！

[前端接入SDK手册](http://doc.aldwx.com/push_new/chanpinshiyongshouce/profession.html)

[API推送调用文档](http://doc.aldwx.com/push_new/jieruwendang/APItuisongdiaoyongwendang.html)

前端开发者接入SDK，提供App_key(sdk的key)，用于校验开发者小程序的能力，有时还需要用户key，用于校验用户的授权情况。

1. 收集粉丝/用户：提供上报 `openid` 或 `jscode` 的方法。

2. 收集 `formId`：还是要用 `<form>`，但提供收集 `formId` 的方法。

[小神推demo](http://tongji.xiaoshentui.com/?demoType=1)

1. 后台统计数据可视化

2. 创建模版/编辑模版等，预览性

3. 选择指定模版，选择指定用户（采集到 formId 根据标签），进行手动发送。

4. 当然也可以预设条件，用户触发自动发送

[新生态统计业务打法调研-七.阿拉丁调研](https://wiki.n.miui.com/pages/viewpage.action?pageId=136096671#id-新生态统计业务打法调研-七.阿拉丁调研)

在小程序推送服务这块，我们可能极大地需要借鉴阿拉丁。简单来说，就是封装小程序接口，提供 SDK 收集推送码，做可视化、模版化配置，让开发者或运营者简洁方便地下发推送。

### 支付宝小程序 (阿里系)

https://docs.alipay.com/mini/introduce/message

抄微信的，没啥区别

目前需要借助支付宝-生活号，类似微信公众号以及微信中的服务通知。

### 头条、抖音小程序 (字节跳动)

抄微信的，没啥区别

而且目前在官网上没有发现明确的推送功能。

### 百度智能小程序

[sendTemplateMessage](https://smartprogram.baidu.com/docs/develop/api/open_infomation/#sendTemplateMessage/)

只看到有消息模版API，但没有发现模板库在哪儿配置或者使用条件。

## PWA

Hybrid App (Ionic)、React Native、Weex 等使用，到 PWA 的发展。

小程序就是一种广义上的PWA，只不过小程序的依赖平台是微信/支付宝等App，而PWA依赖的环境是浏览器。。PWA虽然是一个Web App依赖于浏览器，但是它却支持推送、离线启动、缓存和可安装等。

未来，PWA 有没有可能终极大混战？成为下一代应用标准？

在 [PWA 使用 Push API 实现消息推送](https://www.jianshu.com/p/9970a9340a2d) 一文中，我们可以了解到浏览器是如何实现推送服务的。

但目前来看，比如 H5 上的 IM 或客服，一直是个比较头疼的业务，无论从交互上还是及时准确触达上，以及离线推送或者与系统级、应用级的沟通上，都还有待发展。

## 未来可能性

微信小程序趋于完善，开发者或用户量都是最大的。

对于小程序的模版消息思考：【直达服务】

张小龙在微信公开课演讲时，说他觉得微信里还是很多东西藏得实在太深了！

对于模版消息，用户接受到一条消息，每次得点开微信(1)，点开服务消息(2)，在点击具体的消息(3)，才能进入小程序(4)。能不能跳过2、3，点开消息直接进入小程序呢？

另外值得一提的是，目前微信小程序在 Android 上可以添加至桌面，支付宝小程序在 Android、Ios 上都可以添加至桌面。

最后在说一下多端适配。

我们渴望做成一个这样的服务商，提供同时适配 App (Android、Ios)、快应用、小程序以及未来的 H5-PWA。无论是这样的服务还是这样的 SDK，其实与【多端统一开发框架】不谋而合。

目前京东的 [taro](https://taro.aotu.io/)、滴滴的 [chameleon](https://github.com/didi/chameleon) 都在做【多端统一开发框架】，渴望用一个框架去实现【让一套代码运行多端】。那既然是一个框架，将来接入推送是不是只需要一个 SDK 更合理。这或许是个好的契机。

![taro支持](http://cmspic-10004025.image.myqcloud.com/3f6794a5-d644-440b-a1c6-57c64469279d)

![chameleon支持](https://camo.githubusercontent.com/42b2a5b50c42458554503860448134e3584df446/68747470733a2f2f434d4c4a532e6f72672f646f632f6173736574732f6d76766d342e706e67)

---

参考：

  * [推送](https://baike.baidu.com/item/推送)
  * [推送服务](https://baike.baidu.com/item/推送服务)
  * [信息推送](https://baike.baidu.com/item/信息推送)
  * [长连接](https://baike.baidu.com/item/长连接)
  * [移动端设备标识码：DeviceID、IMEI、IDFA、UDID和UUID等](https://www.jianshu.com/p/38f4d1a4763b)
  * [新生态统计服务](https://wiki.n.miui.com/pages/viewpage.action?pageId=136096632)
  * [快应用-推送能力](https://doc.quickApp.cn/features/service/push.html)
  * [微信小程序-模版消息](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/template-message.html)
  * [微信小程序如何突破模板消息限制，获取多个formId](https://segmentfault.com/a/1190000016214784)
  * [突破微信小程序模板消息限制，实现无限制主动推送](https://blog.csdn.net/rolan1993/article/details/79398362)
  * [为什么别人靠推送能把留存做到40%，而你一推就被封？](https://mp.weixin.qq.com/s/OjQOqHSNbpq9Q9llv8T3-g)
  * [小程序2018年行业报告： 总量或将超500万](http://m.ebrun.com/313595.html?eb=com_chan_lcol_fylb)
  * [PWA 使用 Push API 实现消息推送](https://www.jianshu.com/p/9970a9340a2d)
