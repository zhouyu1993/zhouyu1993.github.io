(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-live-live_private~pages-live-live_public"],{7386:function(e,o,r){"use strict";(function(o){var a=r("288e");r("6b54"),r("ac6a");var t=a(r("0a0d")),s=a(r("f499")),n="https://liveroom.qcloud.com/weapp/live_room/",u="",i=0,c=[],d={userID:"",userName:"",userAvatar:"",userSig:"",sdkAppID:"",accountType:"0",accountMode:0,token:"",accelerateURL:"",pushURL:""},f={roomID:"",roomInfo:"",mixedPlayURL:"",isCreator:!1,pushers:[],isLoginIM:!1,isJoinGroup:!1,isDestory:!1,hasJoinAnchor:!1,roomStatusCode:0},l={onAnchorEnter:function(){},onAnchorExit:function(){},onRoomDestroy:function(){},onRecvRoomTextMsg:function(){},onRequestJoinAnchor:function(){},onKickoutJoinAnchor:function(){},onRecvRoomCustomMsg:function(){},onSketchpadData:function(){}},m=null,I="",g=null,D=0;function h(e){0,c[i++]=uni.request({url:n+e.url+(e.params?"?"+p(e.params)+"&":"?")+"userID="+d.userID+(d.token?"&token="+d.token:""),data:e.data||{},header:{"content-type":"application/json"},method:"POST",success:e.success||function(){},fail:e.fail||function(){},complete:e.complete||function(){0}})}function p(e){var o=[];for(var r in e)o.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return o.join("&")}function _(e){e&&e.data.userID&&e.data.userSig&&e.data.sdkAppID?(o.log("live.login: ",(0,s.default)(e)),d.userID=e.data.userID,d.userName=e.data.userName,d.userAvatar=e.data.userAvatar,d.userSig=e.data.userSig,d.sdkAppID=e.data.sdkAppID,h({url:"login",params:{sdkAppID:d.sdkAppID,userSig:d.userSig},data:{},success:function(r){r.data.code?e.fail&&e.fail(r):(o.log("live.request.login: ",(0,s.default)(r)),d.token=r.data.token,d.userID=r.data.userID,D=Math.round((0,t.default)())-r.data.timestamp,e.success&&e.success(r))},fail:function(o){e.fail&&e.fail(o)}})):e.fail&&e.fail({errCode:-9,errMsg:"init参数错误"})}function C(){h({url:"logout",success:function(e){},fail:function(e){}}),d.userID="",d.userSig="",d.sdkAppID="",d.userName="",d.userAvatar="",d.token=""}function v(e){f.hasJoinAnchor&&A({data:{roomID:f.roomID},success:function(o){M(o.data),e.success&&e.success(o)},fail:function(r){o.log("合并房间信息失败",r),e.fail&&e.fail(r)}})}function M(e){var r=[],a=[],t=0;e.pushers&&e.pushers.forEach(function(e){t=0,f.pushers&&f.pushers.forEach(function(o){e.userID==o.userID&&(t=1)}),t||r.push(e),t=0}),f.pushers&&f.pushers.forEach(function(o){t=0,e.pushers&&e.pushers.forEach(function(e){o.userID==e.userID&&(t=1)}),t||a.push(o),t=0}),e.roomStatusCode&&(f.roomStatusCode=e.roomStatusCode),f.pushers=e.pushers,r.length&&(o.log("有人进入房间",(0,s.default)(r)),l.onAnchorEnter&&l.onAnchorEnter({pushers:r}),z(1)),a.length&&(o.log("有人退出房间",(0,s.default)(a)),l.onAnchorExit&&l.onAnchorExit({pushers:a}),z(1))}function A(e){var r={};if(e.data&&e.data.roomID)r.roomID=e.data.roomID;else{if(!f.roomID)return void(e.fail&&e.fail({errCode:-999,errMsg:"无roomID"}));r.roomID=f.roomID}h({url:"get_anchors",data:r,success:function(r){if(r.data.code)return o.log("请求CGI:get_anchors失败",r),void(e.fail&&e.fail({errCode:r.data.code,errMsg:"请求CGI:get_anchors失败:"+r.data.message+"["+r.data.code+"]"}));e.success&&e.success(r)},fail:e.fail})}function R(e){e&&setTimeout(function(){y()},3e3),u&&setTimeout(function(){y(),R()},7e3)}function y(){h({url:"anchor_heartbeat",data:{roomID:f.roomID,userID:d.userID,roomStatusCode:f.roomStatusCode},success:function(e){e.data.code?o.log("心跳失败：",e):(e.data.pushers&&M(e.data),o.log("心跳成功",e))},fail:function(e){o.log("心跳失败：",e)}})}function k(){u=!1}function x(e){e?h({url:"get_room_list",data:{index:e.data.index||0,cnt:e.data.cnt||20},success:function(r){if(r.data.code)return o.error("获取房间列表失败: ",r),void(e.fail&&e.fail({errCode:r.data.code,errMsg:r.data.message+"["+r.data.code+"]"}));o.log("房间列表信息:",r),e.success&&e.success({rooms:r.data.rooms})},fail:function(r){if(o.log("获取房间列表失败: ",r),"request:fail timeout"==r.errMsg)var a=-1,t="网络请求超时，请检查网络状态";e.fail&&e.fail({errCode:a||-1,errMsg:t||"获取房间列表失败"})}}):e.fail&&e.fail({errCode:-9,errMsg:"getRoomList参数错误"})}function J(e){e?h({url:"get_anchor_url",data:{userID:d.userID},success:function(o){o.data.code?e.fail&&e.fail({errCode:o.data.code,errMsg:o.data.message}):e.success&&e.success({accelerateURL:o.data.accelerateURL,pushURL:o.data.pushURL})},fail:function(o){if("request:fail timeout"==o.errMsg)var r=-1,a="网络请求超时，请检查网络状态";e.fail&&e.fail({errCode:r||-1,errMsg:a||"获取推流地址失败"})}}):e.fail&&e.fail({errCode:-9,errMsg:"getPushURL参数错误"})}function L(e){l.onAnchorEnter=e.onAnchorEnter||function(){},l.onAnchorExit=e.onAnchorExit||function(){},l.onRoomDestroy=e.onRoomDestroy||function(){},l.onRecvRoomTextMsg=e.onRecvRoomTextMsg||function(){},l.onRequestJoinAnchor=e.onRequestJoinAnchor||function(){},l.onKickoutJoinAnchor=e.onKickoutJoinAnchor||function(){},l.onRecvRoomCustomMsg=e.onRecvRoomCustomMsg||function(){},l.onSketchpadData=e.onSketchpadData||function(){}}function U(e){if(f.isCreator=!0,!e||!e.data.roomInfo)return o.log("createRoom参数错误",e),void(e.fail&&e.fail({errCode:-9,errMsg:"createRoom参数错误"}));f.roomInfo=e.data.roomInfo,S(e)}function S(e){var o={userID:d.userID,roomInfo:f.roomInfo};e.data.roomID&&e.data.roomID.length>0&&(o.roomID=e.data.roomID),h({url:"create_room",data:o,success:function(o){o.data.code?e.fail&&e.fail({errCode:o.data.code,errMsg:o.data.message+"["+o.data.code+"]"}):(f.roomID=o.data.roomID,f.roomCreator=d.userID,e.success&&e.success(o))},fail:function(o){if("request:fail timeout"==o.errMsg)var r=-1,a="网络请求超时，请检查网络状态";e.fail&&e.fail({errCode:r||-3,errMsg:a||"创建房间失败"})}})}function w(e){e&&e.data.roomID&&e.data.pushURL?(f.roomID=e.data.roomID,f.isDestory=!1,N(e)):e.fail&&e.fail({errCode:-9,errMsg:"joinAnchor参数错误"})}function N(e){h({url:"add_anchor",data:{roomID:f.roomID,userID:d.userID,userName:d.userName,userAvatar:d.userAvatar,pushURL:e.data.pushURL},success:function(o){o.data.code?e.fail&&e.fail({errCode:o.data.code,errMsg:o.data.message+"["+o.data.code+"]"}):(f.hasJoinAnchor=!0,v(e),u=!0,R(1))},fail:function(o){if("request:fail timeout"==o.errMsg)var r=-1,a="网络请求超时，请检查网络状态";e.fail&&e.fail({errCode:r||-4,errMsg:a||"上麦失败"})}})}function q(e){if(f.isCreator=!1,f.isJoinGroup=!1,e&&e.data.roomID){f.roomID=e.data.roomID;var o={userID:d.userID,userName:d.userName,userAvatar:d.userAvatar};Y({data:{roomID:e.data.roomID,userID:d.userID,userInfo:(0,s.default)(o)},success:function(o){A({data:{roomID:f.roomID},success:function(o){f.roomID=o.data.roomID,f.roomInfo=o.data.roomInfo,f.roomCreator=o.data.roomCreator,f.mixedPlayURL=o.data.mixedPlayURL,e.success&&e.success(o)},fail:function(o){e.fail&&e.fail({errCode:o.errCode,errMsg:o.errMsg||"拉取主播信息失败"})}})},fail:function(o){e.fail&&e.fail({errCode:o.errCode,errMsg:o.errMsg||"观众进房失败"})}})}else e.fail&&e.fail({errCode:-9,errMsg:"enterRoom参数错误"})}function E(e){f.isCreator?T(e):b(e),f.isDestory=!0,f.roomID="",f.pushers=[],f.mixedPlayURL="",f.roomInfo="",d.pushURL="",d.isCreator=!1}function b(e){f.hasJoinAnchor?(k(),h({url:"delete_anchor",data:{roomID:f.roomID,userID:d.userID},success:function(r){if(r.data.code)return o.error("退出推流失败: roomID:"+f.roomID+", userID:"+d.userID),void(e.fail&&e.fail({errCode:r.data.code,errMsg:r.data.message+"["+r.data.code+"]"}));f.hasJoinAnchor=!1,e.success&&e.success({})},fail:function(o){var r=o.errCode||-1,a=o.errMsg||"退出房间失败";"request:fail timeout"==o.errMsg&&(r=-1,a="网络请求超时，请检查网络状态"),e.fail&&e.fail({errCode:r,errMsg:a})}})):Z({data:{userID:d.userID,roomID:f.roomID},success:e.success,fail:e.fail})}function T(e){k(),f.isJoinGroup&&webimhandler.destroyGroup(),f.isDestory||h({url:"destroy_room",data:{roomID:f.roomID,userID:d.userID},success:function(r){if(r.data.code)return o.log("关闭房间失败:",r),o.error("关闭房间失败: roomID:"+f.roomID+", userID:"+d.userID),void(e.fail&&e.fail({errCode:r.data.code,errMsg:r.data.message+"["+r.data.code+"]"}));o.log("关闭房间成功"),e.success&&e.success({})},fail:function(r){o.log("关闭房间失败:",r);var a=r.errCode||-1,t=r.errMsg||"关闭房间失败";"request:fail timeout"==r.errMsg&&(a=-1,t="网络请求超时，请检查网络状态"),e.fail&&e.fail({errCode:a,errMsg:t})}})}function P(e){k(),h({url:"delete_anchor",data:{roomID:f.roomID,userID:d.userID},success:function(r){if(r.data.code)return o.log("退出推流失败:",r),void(e.fail&&e.fail({errCode:r.data.code,errMsg:r.data.message+"["+r.data.code+"]"}));o.log("退出推流成功"),f.pushers=[],e.success&&e.success({})},fail:function(r){if(o.log("退出推流失败:",r),"request:fail timeout"==r.errMsg)var a=-1,t="网络请求超时，请检查网络状态";e.fail&&e.fail({errCode:a||-1,errMsg:t||"退出房间失败"})}}),f.hasJoinAnchor=!1}function j(e){var r={cmd:"linkmic",data:{type:"request",roomID:f.roomID,userID:d.userID,userName:d.userName,userAvatar:d.userAvatar,timestamp:Math.round((0,t.default)())-D}};m=function(o){g&&(clearTimeout(g),g=null),o.errCode?e.fail&&e.fail(o):e.success&&e.success(o)};var a=!1;g=setTimeout(function(){g=null,o.error("申请连麦超时:",(0,s.default)(e.data)),a=!0,m&&m({errCode:-999,errMsg:"申请加入连麦超时"})},e.data&&e.data.timeout?e.data.timeout:3e4);var n={data:(0,s.default)(r)};webimhandler.sendC2CCustomMsg(f.roomCreator,n,function(e){if(!a)return e&&e.errCode?(o.log("请求连麦失败:",(0,s.default)(e)),void(m&&m(e))):void 0})}function G(e){var o={cmd:"linkmic",data:{type:"response",result:"accept",reason:"",roomID:f.roomID,timestamp:Math.round((0,t.default)())-D}},r={data:(0,s.default)(o)};webimhandler.sendC2CCustomMsg(e.data.userID,r,function(e){})}function O(e){var o={cmd:"linkmic",data:{type:"response",result:"reject",reason:e.data.reason||"主播拒绝了您的连麦请求",roomID:f.roomID,timestamp:Math.round((0,t.default)())-D}},r={data:(0,s.default)(o)};webimhandler.sendC2CCustomMsg(e.data.userID,r,function(e){})}function K(e){var o={cmd:"linkmic",data:{type:"kickout",roomID:f.roomID,timestamp:Math.round((0,t.default)())-D}},r={data:(0,s.default)(o)};webimhandler.sendC2CCustomMsg(e.data.userID,r,function(o){o&&0==o.errCode?e.success&&e.success(o):e.fail&&e.fail(o)})}function V(){return d}function z(e){if(d.userID==f.roomCreator){var r=[];f.pushers&&f.pushers.length>0&&f.pushers.forEach(function(e){if(e.userID!=f.roomCreator){var o=B(e.accelerateURL);o&&r.push({userID:e.userID,streamID:o})}else I=B(e.accelerateURL)}),o.log("混流ID信息:",(0,s.default)(r)),F(e,r)}}function B(e){if(!e)return null;var o=e,r=o.indexOf("?");return r>=0&&(o=o.substring(0,r)),o?(r=o.lastIndexOf("/"),r>=0&&(o=o.substring(r+1)),o?(r=o.indexOf("."),r>=0&&(o=o.substring(0,r)),o||null):null):null}function F(e,r){if(!(e<0)){var a=Q(r);o.log("混流参数信息:",(0,s.default)(a)),H(a,function(a){a?o.log("混流成功"):(o.log("混流失败"),setTimeout(function(){e--,F(e,r)},2e3))})}}function H(e,r){h({url:"merge_stream",data:{userID:d.userID,roomID:f.roomID,mergeParams:(0,s.default)(e)},success:function(e){if(e.data.code||e.data.merge_code)return o.error("混流失败:",(0,s.default)(e)),void r(!1);r(!0)},fail:function(e){r(!1)}})}function Q(e){o.log("混流ID信息:",(0,s.default)(e));var r=[];if(r.push({input_stream_id:"canvas1",layout_params:{image_layer:1,image_width:1080,image_height:1080,input_type:3,color:"0x000000"}}),r.push({input_stream_id:I||"",layout_params:{image_layer:2,image_width:540,image_height:540,location_x:270,location_y:0},crop_params:{crop_width:540,crop_height:540,crop_x:0,crop_y:0}}),e&&e.length>0){var a=1;e.forEach(function(e){if(1==a)var o={input_stream_id:e.streamID,layout_params:{image_layer:a+2,image_width:540,image_height:540,location_x:540,location_y:540},crop_params:{crop_width:540,crop_height:540,crop_x:0,crop_y:0}};if(2==a)o={input_stream_id:e.streamID,layout_params:{image_layer:a+2,image_width:540,image_height:540,location_x:0,location_y:540},crop_params:{crop_width:540,crop_height:540,crop_x:0,crop_y:0}};r.push(o),a++})}var n={app_id:d.sdkAppID.toString(),interface:"mix_streamv2.start_mix_stream_advanced",mix_stream_session_id:d.sdkAppID.toString()+"_r"+f.roomID,output_stream_id:d.sdkAppID.toString()+"_r"+f.roomID,output_stream_type:1,input_stream_list:r},u={interfaceName:"Mix_StreamV2",para:n},i={timestamp:Math.round((0,t.default)()/1e3),eventId:Math.round((0,t.default)()/1e3),interface:u};return i}function W(e){1==e?(360,640):(480,640)}function X(e){var r={cmd:e.cmd,data:{userID:d.userID,userName:d.userName,userAvatar:d.userAvatar,msg:e.msg||""}},a={data:(0,s.default)(r)};webimhandler.sendC2CCustomMsg(e.toUserID?e.toUserID:f.roomCreator,a,function(r){if(r&&r.errCode)return o.log("请求连麦失败:",(0,s.default)(r)),void(e.fail&&e.fail(r));e.success&&e.success({})})}function Y(e){h({url:"add_audience",data:{userID:d.userID,roomID:e.data.roomID,userInfo:e.data.userInfo},success:function(r){if(r.data.code)return o.log("观众进房失败",r),void(e.fail&&e.fail({errCode:r.data.code,errMsg:"观众进房失败:"+r.data.message+NaN+r.data.code+"]"}));e.success&&e.success(r)},fail:e.fail})}function Z(e){h({url:"delete_audience",data:{userID:e.data.userID,roomID:e.data.roomID},success:function(r){if(r.data.code)return o.log("减少观众请求失败",r),void(e.fail&&e.fail({errCode:r.data.code,errMsg:"减少观众请求失败:"+r.data.message+NaN+r.data.code+"]"}));e.success&&e.success(r)},fail:e.fail})}e.exports={login:_,logout:C,getRoomList:x,getPushURL:J,createRoom:U,enterRoom:q,exitRoom:E,setListener:L,joinAnchor:w,quitJoinAnchor:P,requestJoinAnchor:j,acceptJoinAnchor:G,rejectJoinAnchor:O,kickoutJoinAnchor:K,getAccountInfo:V,setVideoRatio:W,sendC2CCustomMsg:X,getAnchors:A}}).call(this,r("5a52")["default"])}}]);